<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.talat.pms.dao.RouteDao">
  
  <resultMap id="routeMap" type="route">
    <id column="rno" property="rno"/>
    <result column="spot_order" property="spotOrder"/>
    <result column="lat" property="latitude"/>
    <result column="lng" property="longitude"/>
    <result column="spot_name" property="spotName"/> 
  
  <association property="jno" javaType="journey">
      <id column="journey_no" property="jno"/>
    </association>
  </resultMap>
  
  <insert id="insert" parameterType="route">
    insert into talat_journey_route(jno,lat,lng,spot_name,spot_order) 
    values(
      (select j.jno 
      from talat_journey j
      order by j.jno desc limit 1
      )
    ,#{latitude},#{longitude},#{spotName},#{spotOrder})
  </insert>

  <select id="findByNo" resultMap="routeMap" parameterType="int">
    select
      r.rno,
      r.lat,
      r.lng,
      r.spot_name,
      r.spot_orders,
      j.jno as journey_no
    from talat_journey_route r
      inner join talat_journey j on r.jno=j.jno
    where r.rno = #{value}
  </select>
  
  <select id="findByJourneyNo" resultMap="routeMap" parameterType="int">
    select 
      r.rno,
      r.jno,
      r.spot_order,
      r.spot_name,
      r.lat,
      r.lng
    from talat_journey_route r
      inner join talat_journey j on j.jno=r.jno 
    where j.jno=#{value}
  </select>
  
  <select id="findByJourneyRiderNo" resultMap="routeMap" parameterType="int">
    select 
      r.rno,
      r.jno,
      r.spot_order,
      r.spot_name,
      r.lat,
      r.lng
    from talat_journey_route r
      inner join talat_journey j on j.jno=r.jno 
      inner join talat_journey_rider jr on jr.jno=j.jno
    where jr.rjno=#{value}
  </select>
  
  <select id="findByKeyword" resultMap="routeMap" parameterType="string">
    select
      r.rno,
      r.lat,
      r.lng,
      r.spot_name,
      r.spot_orders,
      j.jno as journey_no
    from talat_journey_route r
      inner join talat_journey j on r.jno=j.jno
    
    <if test="value != null">
    where 
      r.lat like concat('%', #{value},'%')
      and r.lng like concat('%', #{value},'%')
    </if>
    order by r.rno desc
  </select>
  
  <update id="update" parameterType="route">
    update talat_journey_route set
        lat = #{latitude}, 
        lng = #{longitude}, 
        spot_name = #{spotName}
        spot_orders = #{spotOrder}
    where rno = #{rno}
  </update>
  
  <delete id="delete" parameterType="int">
    delete from talat_journey_route
    where jno=#{value}
  </delete>

</mapper>







